<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Modeling Occupancy | Best Practices for Using eBird Data</title>
  <meta name="description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="generator" content="bookdown  and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Modeling Occupancy | Best Practices for Using eBird Data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="github-repo" content="mstrimas/ebird-good-practices" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Modeling Occupancy | Best Practices for Using eBird Data" />
  
  <meta name="twitter:description" content="Best practices for using eBird data to estimate species distributions" />
  

<meta name="author" content="Matthew Strimas-Mackey, Alison Johnston, Wesley M. Hochachka, Viviana Ruiz-Gutierrez, Orin J. Robinson, Eliot T. Miller, Tom Auer, Steve Kelling, Daniel Fink" />


<meta name="date" content="2019-03-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="encounter.html">
<link rel="next" href="abundance.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135911366-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-135911366-1');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">eBird Best Practices</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction and Setup</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#intro-intro"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#intro-pre"><i class="fa fa-check"></i><b>1.2</b> Prerequisites</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#intro-setup"><i class="fa fa-check"></i><b>1.3</b> Setup</a><ul>
<li class="chapter" data-level="1.3.1" data-path="intro.html"><a href="intro.html#intro-setup-data"><i class="fa fa-check"></i><b>1.3.1</b> Data package</a></li>
<li class="chapter" data-level="1.3.2" data-path="intro.html"><a href="intro.html#intro-setup-ebird"><i class="fa fa-check"></i><b>1.3.2</b> Getting eBird data access</a></li>
<li class="chapter" data-level="1.3.3" data-path="intro.html"><a href="intro.html#intro-setup-software"><i class="fa fa-check"></i><b>1.3.3</b> Software</a></li>
<li class="chapter" data-level="1.3.4" data-path="intro.html"><a href="intro.html#intro-setup-packages"><i class="fa fa-check"></i><b>1.3.4</b> R packages</a></li>
<li class="chapter" data-level="1.3.5" data-path="intro.html"><a href="intro.html#intro-setup-tidyverse"><i class="fa fa-check"></i><b>1.3.5</b> Tidyverse</a></li>
<li class="chapter" data-level="1.3.6" data-path="intro.html"><a href="intro.html#intro-setup-gis"><i class="fa fa-check"></i><b>1.3.6</b> GIS data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ebird.html"><a href="ebird.html"><i class="fa fa-check"></i><b>2</b> eBird Data</a><ul>
<li class="chapter" data-level="2.1" data-path="ebird.html"><a href="ebird.html#ebird-intro"><i class="fa fa-check"></i><b>2.1</b> Introduction</a><ul>
<li class="chapter" data-level="2.1.1" data-path="ebird.html"><a href="ebird.html#ebird-intro-tax"><i class="fa fa-check"></i><b>2.1.1</b> eBird taxonomy</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="ebird.html"><a href="ebird.html#ebird-extract"><i class="fa fa-check"></i><b>2.2</b> Data extraction with <code>auk</code></a></li>
<li class="chapter" data-level="2.3" data-path="ebird.html"><a href="ebird.html#ebird-zf"><i class="fa fa-check"></i><b>2.3</b> Importing and zero-filling</a></li>
<li class="chapter" data-level="2.4" data-path="ebird.html"><a href="ebird.html#ebird-detect"><i class="fa fa-check"></i><b>2.4</b> Accounting for variation in detectability</a></li>
<li class="chapter" data-level="2.5" data-path="ebird.html"><a href="ebird.html#ebird-explore"><i class="fa fa-check"></i><b>2.5</b> Exploratory analysis and visualization</a><ul>
<li class="chapter" data-level="2.5.1" data-path="ebird.html"><a href="ebird.html#ebird-explore-time"><i class="fa fa-check"></i><b>2.5.1</b> Time of day</a></li>
<li class="chapter" data-level="2.5.2" data-path="ebird.html"><a href="ebird.html#ebird-explore-duration"><i class="fa fa-check"></i><b>2.5.2</b> Checklist duration</a></li>
<li class="chapter" data-level="2.5.3" data-path="ebird.html"><a href="ebird.html#ebird-explore-distance"><i class="fa fa-check"></i><b>2.5.3</b> Distance traveled</a></li>
<li class="chapter" data-level="2.5.4" data-path="ebird.html"><a href="ebird.html#ebird-explore-observers"><i class="fa fa-check"></i><b>2.5.4</b> Number of observers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="habitat.html"><a href="habitat.html"><i class="fa fa-check"></i><b>3</b> Habitat Covariates</a><ul>
<li class="chapter" data-level="3.1" data-path="habitat.html"><a href="habitat.html#habitat-intro"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="habitat.html"><a href="habitat.html#habitat-dl"><i class="fa fa-check"></i><b>3.2</b> Downloading MODIS data</a><ul>
<li class="chapter" data-level="3.2.1" data-path="habitat.html"><a href="habitat.html#habitat-dl-r"><i class="fa fa-check"></i><b>3.2.1</b> Download using R</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="habitat.html"><a href="habitat.html#habitat-lsm"><i class="fa fa-check"></i><b>3.3</b> Landscape metrics</a></li>
<li class="chapter" data-level="3.4" data-path="habitat.html"><a href="habitat.html#habitat-prediction"><i class="fa fa-check"></i><b>3.4</b> Prediction surface</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="encounter.html"><a href="encounter.html"><i class="fa fa-check"></i><b>4</b> Modeling Encounter Rate</a><ul>
<li class="chapter" data-level="4.1" data-path="encounter.html"><a href="encounter.html#encouter-intro"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="encounter.html"><a href="encounter.html#encounter-data"><i class="fa fa-check"></i><b>4.2</b> Data preparation</a></li>
<li class="chapter" data-level="4.3" data-path="encounter.html"><a href="encounter.html#encounter-sss"><i class="fa fa-check"></i><b>4.3</b> Spatiotemporal subsampling</a></li>
<li class="chapter" data-level="4.4" data-path="encounter.html"><a href="encounter.html#encounter-rf"><i class="fa fa-check"></i><b>4.4</b> Random forests</a><ul>
<li class="chapter" data-level="4.4.1" data-path="encounter.html"><a href="encounter.html#encounter-rf-cal"><i class="fa fa-check"></i><b>4.4.1</b> Calibration</a></li>
<li class="chapter" data-level="4.4.2" data-path="encounter.html"><a href="encounter.html#encounter-rf-assess"><i class="fa fa-check"></i><b>4.4.2</b> Assessment</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="encounter.html"><a href="encounter.html#encounter-habitat"><i class="fa fa-check"></i><b>4.5</b> Environmental associations</a><ul>
<li class="chapter" data-level="4.5.1" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pi"><i class="fa fa-check"></i><b>4.5.1</b> Predictor importance</a></li>
<li class="chapter" data-level="4.5.2" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pd"><i class="fa fa-check"></i><b>4.5.2</b> Partial dependence</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="encounter.html"><a href="encounter.html#encounter-predict"><i class="fa fa-check"></i><b>4.6</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="occupancy.html"><a href="occupancy.html"><i class="fa fa-check"></i><b>5</b> Modeling Occupancy</a><ul>
<li class="chapter" data-level="5.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-intro"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="occupancy.html"><a href="occupancy.html#occupancy-data"><i class="fa fa-check"></i><b>5.2</b> Data preparation</a><ul>
<li class="chapter" data-level="5.2.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-data-sites"><i class="fa fa-check"></i><b>5.2.1</b> Extracting occupancy data</a></li>
<li class="chapter" data-level="5.2.2" data-path="occupancy.html"><a href="occupancy.html#encounter-data-sss"><i class="fa fa-check"></i><b>5.2.2</b> Spatial subsampling</a></li>
<li class="chapter" data-level="5.2.3" data-path="occupancy.html"><a href="occupancy.html#encounter-data-unmarked"><i class="fa fa-check"></i><b>5.2.3</b> <code>unmarked</code> object</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="occupancy.html"><a href="occupancy.html#occupancy-model"><i class="fa fa-check"></i><b>5.3</b> Occupancy modeling</a><ul>
<li class="chapter" data-level="5.3.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-assess"><i class="fa fa-check"></i><b>5.3.1</b> Assessment</a></li>
<li class="chapter" data-level="5.3.2" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-select"><i class="fa fa-check"></i><b>5.3.2</b> Model selection</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="occupancy.html"><a href="occupancy.html#occupancy-predict"><i class="fa fa-check"></i><b>5.4</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="abundance.html"><a href="abundance.html"><i class="fa fa-check"></i><b>6</b> Modeling Relative Abundance</a><ul>
<li class="chapter" data-level="6.1" data-path="abundance.html"><a href="abundance.html#abundance-intro"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="abundance.html"><a href="abundance.html#abundance-data"><i class="fa fa-check"></i><b>6.2</b> Data preparation</a><ul>
<li class="chapter" data-level="6.2.1" data-path="abundance.html"><a href="abundance.html#abundance-data-sss"><i class="fa fa-check"></i><b>6.2.1</b> Spatiotemporal subsampling</a></li>
<li class="chapter" data-level="6.2.2" data-path="abundance.html"><a href="abundance.html#abundance-data-tt"><i class="fa fa-check"></i><b>6.2.2</b> Test-train split</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="abundance.html"><a href="abundance.html#abundance-model"><i class="fa fa-check"></i><b>6.3</b> Abundance models</a><ul>
<li class="chapter" data-level="6.3.1" data-path="abundance.html"><a href="abundance.html#abundance-model-assess"><i class="fa fa-check"></i><b>6.3.1</b> Assessment</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="abundance.html"><a href="abundance.html#abundance-predict"><i class="fa fa-check"></i><b>6.4</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Best Practices for Using eBird Data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="occupancy" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Modeling Occupancy</h1>
<div id="occupancy-intro" class="section level2">
<h2><span class="header-section-number">5.1</span> Introduction</h2>
<p>In this chapter, we’ll cover the basic steps for estimating <strong>occupancy probability</strong> using data from eBird. In Chapter <a href="encounter.html#encounter">4</a>, we used analytical approaches that modeled variation in detectability by inclduing covariates that are known to influence detection rates (e.g. effort). In contrast, occupancy models jointly model the ecological process of species occurrence <em>and</em> the observation process of species detection. The aplication of these models typically requires repeated visits to a single site during a relatively short time frame, over which the population can be considered closed. However, it is possible to <em>impose</em> this repeat visit structure on eBird data to generate a subset of data suitable for estimating occupancy. Here, we discuss how to process eBird observations to meet existing criteria for the application of occupancy models. To illustrate our example, we apply single-season occupancy models to estimate occupancy and detection probabilities of Wood Thrush for the month of June in BCR 27.</p>
<p>This chapter is distinct from the previous chapter on modeling encounter rate in two important ways. First, the random forest model used in Chapter <a href="encounter.html#encounter">4</a> is an example of a <a href="https://en.wikipedia.org/wiki/Machine_learning">machine learning</a> approach, while the occupancy models used in this chapter are a more traditional likelihood approach. This latter type of stastitical approach is best suited for addressing specific questions and hypotheses, while the goal of machine learning is primarily to identify patterns and make predictions <span class="citation">(Bzdok, Altman, and Krzywinski <a href="#ref-bzdokPointsSignificanceStatistics2018">2018</a>)</span>. Second, machine learning approaches can accomodate complex interactions between covariates and non-linear effects, often needed to model habitat associations that can vary across large spatial and temporal scales. In contrast, occupancy models are more suitable for exploring linear effects and simpler interactions. In this example, we specifically focus on the mechanics of filtering and formatting the data to fit occupancy models, and less on how to choose which predictors to include for detection and occupancy probabilities. The predictors we do include are informed by our inferences on variable from the random forest model in Chapter <a href="encounter.html#encounter">4</a>.</p>
<p>If you worked through the previous chapters, you should have all the data necessary for this chapter. You can also <a href="https://github.com/mstrimas/ebird-best-practices/raw/master/data/data.zip">download the data package</a>, and unzip it to your working directory. Note that the Checklist Calibration Index (CCI), which calibrates observers and checklists against others from similar times and places, is an optional covariate in these models. Including CCI typical leads to marked improvement in model performance; however, due to the sensitive nature of these data you will need to <a href="https://ebird.org/data/download">download them separately</a> after you agree to the terms and conditions. If you’ve downloaded these data, put the CCI text file in the <code>data/</code> subdirectory of your project.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(auk)
<span class="kw">library</span>(lubridate)
<span class="kw">library</span>(sf)
<span class="kw">library</span>(dggridR)
<span class="kw">library</span>(unmarked)
<span class="kw">library</span>(raster)
<span class="kw">library</span>(viridis)
<span class="kw">library</span>(MuMIn)
<span class="kw">library</span>(AICcmodavg)
<span class="kw">library</span>(fields)
<span class="kw">library</span>(tidyverse)
<span class="co"># resolve namespace conflicts</span>
select &lt;-<span class="st"> </span>dplyr<span class="op">::</span>select
projection &lt;-<span class="st"> </span>raster<span class="op">::</span>projection

<span class="kw">set.seed</span>(<span class="dv">1</span>)

<span class="co"># ebird data</span>
ebird &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/ebd_woothr_june_bcr27_zf.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">year</span>(observation_date),
         <span class="co"># occupancy modeling requires an integer response</span>
         <span class="dt">species_observed =</span> <span class="kw">as.integer</span>(species_observed))

<span class="co"># modis habitat covariates</span>
habitat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/modis_pland_location-year.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.integer</span>(year))

<span class="co"># combine ebird and habitat data</span>
ebird_habitat &lt;-<span class="st"> </span><span class="kw">inner_join</span>(ebird, habitat, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;locality_id&quot;</span>, <span class="st">&quot;year&quot;</span>))

<span class="co"># optional checklist calibration index</span>
cci_file &lt;-<span class="st"> &quot;data/cci_june_bcr27.csv&quot;</span>
<span class="cf">if</span> (<span class="kw">file.exists</span>(cci_file)) {
  cci &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/cci_june_bcr27.csv&quot;</span>)
  ebird_habitat &lt;-<span class="st"> </span><span class="kw">inner_join</span>(ebird_habitat, cci, <span class="dt">by =</span> <span class="st">&quot;checklist_id&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(checklist_calibration_index))
}

<span class="co"># prediction surface</span>
pred_surface &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/modis_pland_prediction-surface.csv&quot;</span>)
r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;data/prediction-surface.tif&quot;</span>)

<span class="co"># load gis data for making maps</span>
map_proj &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">102003</span>)
ne_land &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_land&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()
bcr &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;bcr&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()
ne_country_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_country_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()
ne_state_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_state_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()</code></pre>
</div>
<div id="occupancy-data" class="section level2">
<h2><span class="header-section-number">5.2</span> Data preparation</h2>
<p>First, we need to extract a subset of the eBird data suitable for occupancy modeling, then perform spatiotemporal subsampling to deal with bias in the data. Let’s start by filtering our data to include only checklists with 5 or fewer observers, since there are very few observations with more than 5 observers.</p>
<pre class="sourceCode r"><code class="sourceCode r">ebird_filtered &lt;-<span class="st"> </span><span class="kw">filter</span>(ebird_habitat, number_observers <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>)</code></pre>
<p>In some situations, you may want to further filter the data based on the results of an exploratory analysis similar to the one conducted in Section <a href="ebird.html#ebird-explore">2.5</a>. However, for the purpose of comparing results among different modeling approaches and best practices, we won’t further filter the observations in eBird for our occupancy example.</p>
<div id="occupancy-data-sites" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Extracting occupancy data</h3>
<p>From the eBird data, we can generate detection histories for each location we define as a site. In this example, we define the month of June as the time period over which we assume that the population is closed for Wood Thrush, and a site is defined as a location (<code>locality_id</code> in the data) that is visited at least twice by the same observer within our defined period of closure (i.e. the month of June).</p>
<p>The <code>auk</code> function <code>filter_repeat_visits()</code> is designed to extract a subset of eBird data suitable for occupancy modeling. We first filter the data to only sites that have at least two visits (<code>min_obs = 2</code>), then define the maximum length of our detection history as 10 visits or checklists (<code>max_obs = 10</code>). When a specific site has been visited more than 10 times, the function will randomly select 10 checklists from the total number of visits. Since we only have data from June, using <code>annual_closure = TRUE</code> defines the temporal period of closure as the whole month of June for a given primary sampling period (i.e. year). Finally, <code>site_vars</code> specifies the set of variables that defines a site. In this example, a site is defined jointly by location and observer IDs.</p>
<pre class="sourceCode r"><code class="sourceCode r">occ &lt;-<span class="st"> </span><span class="kw">filter_repeat_visits</span>(ebird_filtered <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">c</span>(<span class="st">&quot;latitude&quot;</span>, <span class="st">&quot;longitude&quot;</span>), <span class="op">~</span><span class="st"> </span><span class="kw">round</span>(., <span class="dv">4</span>)), 
                            <span class="dt">min_obs =</span> <span class="dv">2</span>, <span class="dt">max_obs =</span> <span class="dv">10</span>,
                            <span class="dt">annual_closure =</span> <span class="ot">TRUE</span>,
                            <span class="dt">date_var =</span> <span class="st">&quot;observation_date&quot;</span>,
                            <span class="dt">site_vars =</span> <span class="kw">c</span>(<span class="st">&quot;locality_id&quot;</span>, <span class="st">&quot;observer_id&quot;</span>))
<span class="co"># entire data set</span>
<span class="kw">nrow</span>(ebird_habitat)
<span class="co">#&gt; [1] 40477</span>
<span class="co"># reduced data set</span>
<span class="kw">nrow</span>(occ)
<span class="co">#&gt; [1] 14428</span>
<span class="co"># how many individual sites there are</span>
<span class="kw">n_distinct</span>(occ<span class="op">$</span>site)
<span class="co">#&gt; [1] 4167</span></code></pre>
<p>Three new variables are added to the dataset by <code>filter_repeat_visits()</code>: <code>site</code> is a unique site ID, <code>closure_id</code> identifies the primary period of closure (in this case the year), and <code>n_observations</code> is the number of visits to each site. Our data is now formatted and ready to be analyzed using occupancy models. Note that we’ve made a tradeoff in sample size, dropping from 40,059 checklists to 14,428 checklists over 4,167 sites.</p>
<p>We’ll fit single-season occupancy models using the <code>unmarked</code> R package. For further details on the type of data format required for this package, consult the documentation for the <code>unmarked</code> function <code>formatWide()</code>. The <code>auk</code> function <code>format_unmarked_occu()</code> converts data from a vertical format in which each row is an observation (as in the EBD) to a horizontal detection history required by <code>unmarked</code>, where each row is a site. At this stage, we need to specify which variables will be site-level covariates and which will be observation-level covariates. Covariates for each site (<code>site_covs</code>) are specific to each primary sampling period of closure (month of June in this case), and will influence the ecological process of species occurrence. Covariates collected during each sampling occasion (<code>obs_covs</code>) are those that are specific to that sampling occasion (i.e. checklist) and will influence the observational process, or detection probability.</p>
<p>For this example, we’ll use MODIS habitat variables as covariates for modeling the occupancy probability of Wood Thrush. Based on <a href="encounter.html#encounter-habitat-pi">predictor importance</a> measures from Chapter <a href="encounter.html#encounter">4</a>, we include deciduous broadleaf forest (<code>pland_04</code>) and mixed forest (<code>pland_05</code>) as habitat types for which we expect positive relationships with occupancy, and croplands (<code>pland_12</code>) and urban (<code>pland_13</code>), for which we expect negative relationships.</p>
<p>For detection probability, we include the six effort variables, since they are related to the detection process. In addition, habitat is known to affect detectability, and many species are harder to detect in densely forested habitats—the same habitats preferred by Wood Thrush. Occupancy models allow us to tease apart the differing effects of habitat on detection and occupancy. With this in mind, we’ll include deciduous broadleaf forest (<code>pland_04</code>) and mixed forest (<code>pland_05</code>) as additional detection covariates.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># if cci is available, use it as an observation covariate</span>
obs_covs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;time_observations_started&quot;</span>, 
              <span class="st">&quot;duration_minutes&quot;</span>, 
              <span class="st">&quot;effort_distance_km&quot;</span>, 
              <span class="st">&quot;number_observers&quot;</span>, 
              <span class="st">&quot;protocol_type&quot;</span>,
              <span class="st">&quot;pland_04&quot;</span>, 
              <span class="st">&quot;pland_05&quot;</span>)
<span class="cf">if</span> (<span class="st">&quot;checklist_calibration_index&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(occ)) {
  obs_covs &lt;-<span class="st"> </span><span class="kw">c</span>(obs_covs, <span class="st">&quot;checklist_calibration_index&quot;</span>)
}

<span class="co"># format for unmarked</span>
occ_wide &lt;-<span class="st"> </span><span class="kw">format_unmarked_occu</span>(occ, 
                                 <span class="dt">site_id =</span> <span class="st">&quot;site&quot;</span>, 
                                 <span class="dt">response =</span> <span class="st">&quot;species_observed&quot;</span>,
                                 <span class="dt">site_covs =</span> <span class="kw">c</span>(<span class="st">&quot;n_observations&quot;</span>, 
                                               <span class="st">&quot;latitude&quot;</span>, <span class="st">&quot;longitude&quot;</span>, 
                                               <span class="co"># % deciduous forest</span>
                                               <span class="st">&quot;pland_04&quot;</span>, 
                                               <span class="co"># % mixed forest</span>
                                               <span class="st">&quot;pland_05&quot;</span>,
                                               <span class="co"># % cropland</span>
                                               <span class="st">&quot;pland_12&quot;</span>,
                                               <span class="co"># % urban</span>
                                               <span class="st">&quot;pland_13&quot;</span>),
                                 <span class="dt">obs_covs =</span> obs_covs)</code></pre>
</div>
<div id="encounter-data-sss" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Spatial subsampling</h3>
<p>As discussed in Section <a href="encounter.html#encounter-sss">4.3</a>, spatial subsampling of eBird observations reduces spatial bias. We’ll use the same hexagonal subsampling approach as in Chapter <a href="encounter.html#encounter">4</a>; however, here we’ll subsample at the level of sites rather than observations.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># generate hexagonal grid with ~ 5 km betweeen cells</span>
dggs &lt;-<span class="st"> </span><span class="kw">dgconstruct</span>(<span class="dt">spacing =</span> <span class="dv">5</span>)
<span class="co"># get hexagonal cell id for each site</span>
occ_wide_cell &lt;-<span class="st"> </span>occ_wide <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cell =</span> <span class="kw">dgGEO_to_SEQNUM</span>(dggs, longitude, latitude)<span class="op">$</span>seqnum)
<span class="co"># sample one checklist per grid cell</span>
occ_ss &lt;-<span class="st"> </span>occ_wide_cell <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(cell) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>cell)</code></pre>
<p>This resulted in a 69.1% decrease in the number of sites.</p>
</div>
<div id="encounter-data-unmarked" class="section level3">
<h3><span class="header-section-number">5.2.3</span> <code>unmarked</code> object</h3>
<p>Finally, we’ll convert this dataframe of observations into an <code>unmarked</code> object, which is required for fitting occupancy models.</p>
<pre class="sourceCode r"><code class="sourceCode r">occ_um &lt;-<span class="st"> </span><span class="kw">formatWide</span>(occ_ss, <span class="dt">type =</span> <span class="st">&quot;unmarkedFrameOccu&quot;</span>)
<span class="kw">summary</span>(occ_um)
<span class="co">#&gt; unmarkedFrame Object</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 1289 sites</span>
<span class="co">#&gt; Maximum number of observations per site: 10 </span>
<span class="co">#&gt; Mean number of observations per site: 3.19 </span>
<span class="co">#&gt; Sites with at least one detection: 141 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tabulation of y observations:</span>
<span class="co">#&gt;    0    1 &lt;NA&gt; </span>
<span class="co">#&gt; 3864  245 8781 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Site-level covariates:</span>
<span class="co">#&gt;  n_observations     latitude      longitude        pland_04    </span>
<span class="co">#&gt;  Min.   : 2.00   Min.   :29.4   Min.   :-91.4   Min.   :0.000  </span>
<span class="co">#&gt;  1st Qu.: 2.00   1st Qu.:31.0   1st Qu.:-86.1   1st Qu.:0.000  </span>
<span class="co">#&gt;  Median : 2.00   Median :32.7   Median :-81.7   Median :0.000  </span>
<span class="co">#&gt;  Mean   : 3.19   Mean   :33.2   Mean   :-82.3   Mean   :0.067  </span>
<span class="co">#&gt;  3rd Qu.: 3.00   3rd Qu.:35.1   3rd Qu.:-78.3   3rd Qu.:0.040  </span>
<span class="co">#&gt;  Max.   :10.00   Max.   :38.3   Max.   :-75.5   Max.   :1.000  </span>
<span class="co">#&gt;     pland_05        pland_12        pland_13    </span>
<span class="co">#&gt;  Min.   :0.000   Min.   :0.000   Min.   :0.000  </span>
<span class="co">#&gt;  1st Qu.:0.000   1st Qu.:0.000   1st Qu.:0.000  </span>
<span class="co">#&gt;  Median :0.000   Median :0.000   Median :0.000  </span>
<span class="co">#&gt;  Mean   :0.051   Mean   :0.036   Mean   :0.112  </span>
<span class="co">#&gt;  3rd Qu.:0.000   3rd Qu.:0.000   3rd Qu.:0.080  </span>
<span class="co">#&gt;  Max.   :0.960   Max.   :1.000   Max.   :1.000  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Observation-level covariates:</span>
<span class="co">#&gt;  time_observations_started duration_minutes effort_distance_km</span>
<span class="co">#&gt;  Min.   : 0                Min.   :  1      Min.   :0         </span>
<span class="co">#&gt;  1st Qu.: 8                1st Qu.: 15      1st Qu.:0         </span>
<span class="co">#&gt;  Median :10                Median : 33      Median :0         </span>
<span class="co">#&gt;  Mean   :12                Mean   : 53      Mean   :1         </span>
<span class="co">#&gt;  3rd Qu.:16                3rd Qu.: 70      3rd Qu.:1         </span>
<span class="co">#&gt;  Max.   :24                Max.   :300      Max.   :5         </span>
<span class="co">#&gt;  NA&#39;s   :8781              NA&#39;s   :8781     NA&#39;s   :8781      </span>
<span class="co">#&gt;  number_observers protocol_type         pland_04       pland_05   </span>
<span class="co">#&gt;  Min.   :1        Length:12890       Min.   :0      Min.   :0     </span>
<span class="co">#&gt;  1st Qu.:1        Class :character   1st Qu.:0      1st Qu.:0     </span>
<span class="co">#&gt;  Median :1        Mode  :character   Median :0      Median :0     </span>
<span class="co">#&gt;  Mean   :1                           Mean   :0      Mean   :0     </span>
<span class="co">#&gt;  3rd Qu.:1                           3rd Qu.:0      3rd Qu.:0     </span>
<span class="co">#&gt;  Max.   :5                           Max.   :1      Max.   :1     </span>
<span class="co">#&gt;  NA&#39;s   :8781                        NA&#39;s   :8781   NA&#39;s   :8781  </span>
<span class="co">#&gt;  checklist_calibration_index</span>
<span class="co">#&gt;  Min.   :-4                 </span>
<span class="co">#&gt;  1st Qu.:-1                 </span>
<span class="co">#&gt;  Median : 0                 </span>
<span class="co">#&gt;  Mean   : 0                 </span>
<span class="co">#&gt;  3rd Qu.: 1                 </span>
<span class="co">#&gt;  Max.   : 2                 </span>
<span class="co">#&gt;  NA&#39;s   :8781</span></code></pre>
</div>
</div>
<div id="occupancy-model" class="section level2">
<h2><span class="header-section-number">5.3</span> Occupancy modeling</h2>
<p>Now that we’ve created a data frame with detection histories and covariates, we can use <code>unmarked</code> to fit a single-season occupancy model. In this book, we won’t delve into the mechanics of occupacy models; however, there is a rich literature on occupancy modeling and readers wishing to learn more about this field may want to consult the book on the topic by MacKenzie et al. <span class="citation">(<a href="#ref-mackenzieOccupancyEstimationModeling2017">2017</a>)</span>. Here we simply fit a single-season occupancy model to our data using the <code>occu()</code> function, specifying the detection and occupancy covariates, respectively, via a double right-hand sided formula of the form <code>~ detection covariates ~ occupancy covariates</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># use cci in model formula if available</span>
<span class="cf">if</span> (<span class="st">&quot;checklist_calibration_index&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(occ_um<span class="op">@</span>obsCovs)) {
  mod_formula &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>time_observations_started <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>duration_minutes <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>effort_distance_km <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>number_observers <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>protocol_type <span class="op">+</span>
<span class="st">                    </span>checklist_calibration_index <span class="op">+</span>
<span class="st">                    </span>pland_<span class="dv">04</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">05</span> <span class="op">~</span><span class="st"> </span>
<span class="st">                  </span>pland_<span class="dv">04</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">05</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">13</span>
} <span class="cf">else</span> {
    mod_formula &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>time_observations_started <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>duration_minutes <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>effort_distance_km <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>number_observers <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>protocol_type <span class="op">+</span>
<span class="st">                    </span>pland_<span class="dv">04</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">05</span> <span class="op">~</span>
<span class="st">                  </span>pland_<span class="dv">04</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">05</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">13</span>
}

<span class="co"># fit model</span>
occ_model &lt;-<span class="st"> </span><span class="kw">occu</span>(mod_formula, <span class="dt">data =</span> occ_um)
<span class="co"># look at the regression coefficients from the models</span>
<span class="kw">summary</span>(occ_model)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; occu(formula = mod_formula, data = occ_um)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Occupancy (logit-scale):</span>
<span class="co">#&gt;             Estimate    SE       z  P(&gt;|z|)</span>
<span class="co">#&gt; (Intercept)   -1.939 0.172 -11.263 1.99e-29</span>
<span class="co">#&gt; pland_04       2.969 1.111   2.673 7.53e-03</span>
<span class="co">#&gt; pland_05       4.632 1.627   2.846 4.43e-03</span>
<span class="co">#&gt; pland_12       0.605 0.693   0.872 3.83e-01</span>
<span class="co">#&gt; pland_13      -1.988 0.794  -2.505 1.22e-02</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Detection (logit-scale):</span>
<span class="co">#&gt;                             Estimate      SE       z  P(&gt;|z|)</span>
<span class="co">#&gt; (Intercept)                 -1.08470 0.39483 -2.7472 6.01e-03</span>
<span class="co">#&gt; time_observations_started   -0.02964 0.02056 -1.4417 1.49e-01</span>
<span class="co">#&gt; duration_minutes             0.00751 0.00195  3.8568 1.15e-04</span>
<span class="co">#&gt; effort_distance_km          -0.00127 0.09506 -0.0134 9.89e-01</span>
<span class="co">#&gt; number_observers             0.13358 0.17132  0.7797 4.36e-01</span>
<span class="co">#&gt; protocol_typeTraveling       0.44427 0.25440  1.7463 8.08e-02</span>
<span class="co">#&gt; checklist_calibration_index  0.59939 0.12392  4.8369 1.32e-06</span>
<span class="co">#&gt; pland_04                    -0.96265 0.71943 -1.3381 1.81e-01</span>
<span class="co">#&gt; pland_05                    -0.67993 0.65596 -1.0365 3.00e-01</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; AIC: 1390 </span>
<span class="co">#&gt; Number of sites: 1289</span>
<span class="co">#&gt; optim convergence code: 0</span>
<span class="co">#&gt; optim iterations: 77 </span>
<span class="co">#&gt; Bootstrap iterations: 0</span></code></pre>
<div id="occupancy-model-assess" class="section level3">
<h3><span class="header-section-number">5.3.1</span> Assessment</h3>
<p>Occupancy models assume that at at least one model in the set provides an adequate fit to the data. Although few goodness-of-fit tests exist for occupancy models, we’ll demonstrate how to perform the MacKenzie and Bailey <span class="citation">(<a href="#ref-mackenzieAssessingFitSiteoccupancy2004">2004</a>)</span> goodness-of-fit test. This approach calculates a Pearson’s chi-square fit statistic from the observed and expected frequencies of detection histories for a given model. For this example, we’ll use the <code>mb.gof.test()</code> test function in the <code>AICcmodavg</code> package, which can handle occupancy models produced by the <code>occu()</code> function in <code>unmarked</code>, to calculate the observed and expected frequencies of detection histories. Note that this process requires simulating a large number of bootstrap samples (1,000 here) and therefore takes a long time to run. You may want to skip this section or reduce <code>nsim</code> to a much smaller number (e.g. 10) in the interest of speed. However, when applying this in practice, you should run the test with the full number of simulations to get accurate results.</p>
<pre class="sourceCode r"><code class="sourceCode r">occ_gof &lt;-<span class="st"> </span><span class="kw">mb.gof.test</span>(occ_model, <span class="dt">nsim =</span> <span class="dv">1000</span>, <span class="dt">plot.hist =</span> <span class="ot">FALSE</span>)
<span class="kw">print</span>(occ_gof)</code></pre>
<pre><code>#&gt; 
#&gt; MacKenzie and Bailey goodness-of-fit for single-season occupancy model
#&gt; 
#&gt; Chi-square statistic = 1987 
#&gt; Number of bootstrap samples = 1000
#&gt; P-value = 0.324
#&gt; 
#&gt; Quantiles of bootstrapped statistics:
#&gt;    0%   25%   50%   75%  100% 
#&gt;   330  1256  1661  2199 49998 
#&gt; 
#&gt; Estimate of c-hat = 0.97</code></pre>
<p>For this example, the probability of getting the calculated chi-square statistic under a null sampling distribution is indicated by the p-value of 0.324, indicating that there is no reason to consider a lack of fit (p &gt; 0.1). In addition, we also get an estimate of the overdisperson parameter (c-hat) for the model by dividing the observed chi-square statistic by the mean of the statistics obtained from simulation. In this example, c-hat = 0.97, which is very close to c-hat = 1, indicating that the variance is not greater than the mean, and that there is no evidence for overdispersion.</p>
</div>
<div id="occupancy-model-select" class="section level3">
<h3><span class="header-section-number">5.3.2</span> Model selection</h3>
<p>Next, we use a model selection approach to compare and rank our candidate model set. For this example, we use the <code>dredge()</code> function to explore a candidate set consisting of all possible additive combinations of the global model. However, we suggest that a more thoughtful approach be considered for specific applications and different types of predictor variables.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># dredge candidate model set</span>
occ_dredge &lt;-<span class="st"> </span><span class="kw">dredge</span>(occ_model)

<span class="co"># model comparison</span>
<span class="kw">select</span>(occ_dredge, df, logLik, AICc, delta, weight)</code></pre>
<pre><code>#&gt;    df logLik AICc delta   weight
#&gt; 12 13   -681 1389  0.00 6.41e-01
#&gt; 16 14   -681 1390  1.33 3.30e-01
#&gt; 4  12   -686 1396  7.37 1.61e-02
#&gt; 8  13   -685 1396  7.88 1.25e-02
#&gt; 11 12   -689 1403 14.17 5.38e-04
#&gt; 15 13   -689 1405 16.07 2.07e-04
#&gt; 10 12   -691 1406 17.08 1.25e-04
#&gt; 14 13   -691 1408 18.96 4.90e-05
#&gt; 3  11   -696 1415 26.31 1.24e-06
#&gt; 7  12   -696 1416 27.73 6.10e-07
#&gt; 2  11   -698 1419 30.34 1.65e-07
#&gt; 6  12   -698 1420 31.61 8.77e-08
#&gt; 9  11   -700 1423 33.94 2.73e-08
#&gt; 13 12   -700 1425 35.96 9.97e-09
#&gt; 1  10   -712 1444 55.24 6.48e-13
#&gt; 5  11   -712 1446 57.19 2.44e-13</code></pre>
<p>A quick look at the dredge object reveals that there is not a clear model, or even set of models, that are most likely to have generated our data. This is evident from the low AIC weight for the model with the lowest AICc value. Given this, and the fact that all of our effects are linear and use the same family and link function, we’ll average across all models, weighted by AICc, to produce a final model that we’ll use for prediction. However, there may be scenarios in which there is a clear set of high performing models, in which case you can use the <code>get.models()</code> function to extract just these models prior to averaging.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># average models based on model weights </span>
occ_avg &lt;-<span class="st"> </span><span class="kw">model.avg</span>(occ_dredge, <span class="dt">fit =</span> <span class="ot">TRUE</span>)

<span class="co"># model coefficients</span>
<span class="kw">t</span>(occ_avg<span class="op">$</span>coefficients)
<span class="co">#&gt;                                     full    subset</span>
<span class="co">#&gt; psi(Int)                       -1.916089 -1.916089</span>
<span class="co">#&gt; psi(pland_04)                   2.922477  2.924661</span>
<span class="co">#&gt; psi(pland_05)                   4.596419  4.597220</span>
<span class="co">#&gt; psi(pland_13)                  -1.977705 -2.035802</span>
<span class="co">#&gt; p(Int)                         -1.096517 -1.096517</span>
<span class="co">#&gt; p(checklist_calibration_index)  0.604441  0.604441</span>
<span class="co">#&gt; p(duration_minutes)             0.007494  0.007494</span>
<span class="co">#&gt; p(effort_distance_km)          -0.000105 -0.000105</span>
<span class="co">#&gt; p(number_observers)             0.133860  0.133860</span>
<span class="co">#&gt; p(pland_04)                    -0.954926 -0.954926</span>
<span class="co">#&gt; p(pland_05)                    -0.679792 -0.679792</span>
<span class="co">#&gt; p(protocol_typeTraveling)       0.447396  0.447396</span>
<span class="co">#&gt; p(time_observations_started)   -0.029042 -0.029042</span>
<span class="co">#&gt; psi(pland_12)                   0.210509  0.614722</span></code></pre>
</div>
</div>
<div id="occupancy-predict" class="section level2">
<h2><span class="header-section-number">5.4</span> Prediction</h2>
<p>In this section, we’ll estimate the distribution of Wood Thrush in BCR 27. Similar to Section <a href="habitat.html#habitat-prediction">3.4</a>, we’ll generate a prediction surface using the PLAND habitat covariates summarized on a regular grid of points across BCR 27. For this, we’ll use the <code>predict()</code> function to estimate occupancy probabilities, standard errors, and confidence intervals.</p>
<p>Recall that when we <a href="encounter.html#encounter-predict">predicted encouter rate</a>, we had to include effort variables in our prediction surface. We don’t need to do that here because the occupancy submodel doesn’t depend on the effort covariates, these only occur in the detection submodel.</p>
<pre class="sourceCode r"><code class="sourceCode r">occ_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(occ_avg, 
                    <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(pred_surface), 
                    <span class="dt">type =</span> <span class="st">&quot;state&quot;</span>)

<span class="co"># add to prediction surface</span>
pred_occ &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(pred_surface, 
                      <span class="dt">occ_prob =</span> occ_pred<span class="op">$</span>fit, 
                      <span class="dt">occ_se =</span> occ_pred<span class="op">$</span>se.fit) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(latitude, longitude, occ_prob, occ_se)</code></pre>
<p>Next, we’ll convert this data frame to spatial feaatures using <code>sf</code>, then rasterize the points using the prediction surface raster template.</p>
<pre class="sourceCode r"><code class="sourceCode r">r_pred &lt;-<span class="st"> </span>pred_occ <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># convert to spatial features</span>
<span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> <span class="kw">projection</span>(r)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># rasterize</span>
<span class="st">  </span><span class="kw">rasterize</span>(r)
r_pred &lt;-<span class="st"> </span>r_pred[[<span class="kw">c</span>(<span class="st">&quot;occ_prob&quot;</span>, <span class="st">&quot;occ_se&quot;</span>)]]

<span class="co"># save the raster</span>
<span class="kw">writeRaster</span>(r_pred[[<span class="st">&quot;occ_prob&quot;</span>]], 
            <span class="dt">filename =</span> <span class="st">&quot;output/woothr_occupancy-model_prob.tif&quot;</span>,
            <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)
<span class="kw">writeRaster</span>(r_pred[[<span class="st">&quot;occ_se&quot;</span>]], 
            <span class="dt">filename =</span> <span class="st">&quot;output/woothr_occupancy-model_se.tif&quot;</span>, 
            <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</code></pre>
<p>Finally, we can map these predictions!</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># project predictions</span>
r_pred_proj &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(r_pred, <span class="dt">crs =</span> map_proj<span class="op">$</span>proj4string, <span class="dt">method =</span> <span class="st">&quot;ngb&quot;</span>)

<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))
<span class="cf">for</span> (nm <span class="cf">in</span> <span class="kw">names</span>(r_pred)) {
  r_plot &lt;-<span class="st"> </span>r_pred_proj[[nm]]
  
  <span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">3.5</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>))
  <span class="co"># set up plot area</span>
  <span class="kw">plot</span>(bcr, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="ot">NA</span>)
  <span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">border =</span> <span class="st">&quot;#888888&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  
  <span class="co"># modified plasma palette</span>
  plasma_rev &lt;-<span class="st"> </span><span class="kw">rev</span>(<span class="kw">plasma</span>(<span class="dv">25</span>, <span class="dt">end =</span> <span class="fl">0.9</span>))
  gray_int &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(<span class="kw">c</span>(<span class="st">&quot;#dddddd&quot;</span>, plasma_rev[<span class="dv">1</span>]))
  pal &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">gray_int</span>(<span class="dv">4</span>)[<span class="dv">2</span>], plasma_rev)
  
  <span class="co"># occupancy</span>
  mx &lt;-<span class="st"> </span><span class="kw">ceiling</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span><span class="kw">cellStats</span>(r_plot, max)) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>
  brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, mx, <span class="dt">length.out =</span> <span class="kw">length</span>(pal) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)
  <span class="kw">plot</span>(r_plot, 
       <span class="dt">col =</span> pal, <span class="dt">breaks =</span> brks, 
       <span class="dt">maxpixels =</span> <span class="kw">ncell</span>(r_plot),
       <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  
  <span class="co"># borders</span>
  <span class="kw">plot</span>(bcr, <span class="dt">border =</span> <span class="st">&quot;#000000&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">box</span>()
  
  <span class="co"># legend</span>
  <span class="kw">par</span>(<span class="dt">new =</span> <span class="ot">TRUE</span>, <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))
  <span class="cf">if</span> (nm <span class="op">==</span><span class="st"> &quot;occ_prob&quot;</span>) {
    title &lt;-<span class="st"> &quot;Wood Thrush Occupancy Probability&quot;</span>
    lbl_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, mx, <span class="dt">by =</span> <span class="fl">0.1</span>)
  } <span class="cf">else</span> {
    lbl_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, mx, <span class="dt">by =</span> <span class="fl">0.02</span>)
    title &lt;-<span class="st"> &quot;Wood Thrush Occupancy Uncertainty (SE)&quot;</span>
  }
  
  <span class="kw">image.plot</span>(<span class="dt">zlim =</span> <span class="kw">range</span>(brks), <span class="dt">legend.only =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> pal,
             <span class="dt">smallplot =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.06</span>, <span class="fl">0.09</span>),
             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>,
             <span class="dt">axis.args =</span> <span class="kw">list</span>(<span class="dt">at =</span> lbl_brks, <span class="dt">labels =</span> lbl_brks,
                              <span class="dt">fg =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">col.axis =</span> <span class="st">&quot;black&quot;</span>,
                              <span class="dt">cex.axis =</span> <span class="fl">0.75</span>, <span class="dt">lwd.ticks =</span> <span class="fl">0.5</span>,
                              <span class="dt">padj =</span> <span class="fl">-1.5</span>),
             <span class="dt">legend.args =</span> <span class="kw">list</span>(<span class="dt">text =</span> title,
                                <span class="dt">side =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>,
                                <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">line =</span> <span class="dv">0</span>))
}</code></pre>
<p><img src="ebird-best-practices_files/figure-html/occupancy-predict-map-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-bzdokPointsSignificanceStatistics2018">
<p>Bzdok, Danilo, Naomi Altman, and Martin Krzywinski. 2018. “Points of Significance: Statistics Versus Machine Learning.” <em>Nature Methods</em> 15 (April): 233–34. <a href="https://doi.org/10.1038/nmeth.4642">https://doi.org/10.1038/nmeth.4642</a>.</p>
</div>
<div id="ref-mackenzieAssessingFitSiteoccupancy2004">
<p>MacKenzie, Darryl I., and Larissa L. Bailey. 2004. “Assessing the Fit of Site-Occupancy Models.” <em>Journal of Agricultural, Biological, and Environmental Statistics</em> 9 (3): 300–318.</p>
</div>
<div id="ref-mackenzieOccupancyEstimationModeling2017">
<p>MacKenzie, Darryl I., James D. Nichols, J. Andrew Royle, Kenneth H. Pollock, Larissa Bailey, and James E. Hines. 2017. <em>Occupancy Estimation and Modeling: Inferring Patterns and Dynamics of Species Occurrence</em>. Elsevier.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="encounter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="abundance.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/mstrimas/ebird-best-practices/edit/master/05_occupancy.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
