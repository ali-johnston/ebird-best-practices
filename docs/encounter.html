<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Modeling Encounter Rate | Best Practices for Using eBird Data</title>
  <meta name="description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="generator" content="bookdown  and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Modeling Encounter Rate | Best Practices for Using eBird Data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="github-repo" content="mstrimas/ebird-good-practices" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Modeling Encounter Rate | Best Practices for Using eBird Data" />
  
  <meta name="twitter:description" content="Best practices for using eBird data to estimate species distributions" />
  

<meta name="author" content="Matthew Strimas-Mackey, Alison Johnston, Wesley M. Hochachka, Viviana Ruiz-Gutierrez, Orin J. Robinson, Eliot T. Miller, Tom Auer, Steve Kelling, Daniel Fink" />


<meta name="date" content="2019-03-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="habitat.html">
<link rel="next" href="occupancy.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135911366-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-135911366-1');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">eBird Best Practices</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction and Setup</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#intro-intro"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#intro-pre"><i class="fa fa-check"></i><b>1.2</b> Prerequisites</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#intro-setup"><i class="fa fa-check"></i><b>1.3</b> Setup</a><ul>
<li class="chapter" data-level="1.3.1" data-path="intro.html"><a href="intro.html#intro-setup-data"><i class="fa fa-check"></i><b>1.3.1</b> Data package</a></li>
<li class="chapter" data-level="1.3.2" data-path="intro.html"><a href="intro.html#intro-setup-ebird"><i class="fa fa-check"></i><b>1.3.2</b> Getting eBird data access</a></li>
<li class="chapter" data-level="1.3.3" data-path="intro.html"><a href="intro.html#intro-setup-software"><i class="fa fa-check"></i><b>1.3.3</b> Software</a></li>
<li class="chapter" data-level="1.3.4" data-path="intro.html"><a href="intro.html#intro-setup-packages"><i class="fa fa-check"></i><b>1.3.4</b> R packages</a></li>
<li class="chapter" data-level="1.3.5" data-path="intro.html"><a href="intro.html#intro-setup-tidyverse"><i class="fa fa-check"></i><b>1.3.5</b> Tidyverse</a></li>
<li class="chapter" data-level="1.3.6" data-path="intro.html"><a href="intro.html#intro-setup-gis"><i class="fa fa-check"></i><b>1.3.6</b> GIS data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ebird.html"><a href="ebird.html"><i class="fa fa-check"></i><b>2</b> eBird Data</a><ul>
<li class="chapter" data-level="2.1" data-path="ebird.html"><a href="ebird.html#ebird-intro"><i class="fa fa-check"></i><b>2.1</b> Introduction</a><ul>
<li class="chapter" data-level="2.1.1" data-path="ebird.html"><a href="ebird.html#ebird-intro-tax"><i class="fa fa-check"></i><b>2.1.1</b> eBird taxonomy</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="ebird.html"><a href="ebird.html#ebird-extract"><i class="fa fa-check"></i><b>2.2</b> Data extraction with <code>auk</code></a></li>
<li class="chapter" data-level="2.3" data-path="ebird.html"><a href="ebird.html#ebird-zf"><i class="fa fa-check"></i><b>2.3</b> Importing and zero-filling</a></li>
<li class="chapter" data-level="2.4" data-path="ebird.html"><a href="ebird.html#ebird-detect"><i class="fa fa-check"></i><b>2.4</b> Accounting for variation in detectability</a></li>
<li class="chapter" data-level="2.5" data-path="ebird.html"><a href="ebird.html#ebird-explore"><i class="fa fa-check"></i><b>2.5</b> Exploratory analysis and visualization</a><ul>
<li class="chapter" data-level="2.5.1" data-path="ebird.html"><a href="ebird.html#ebird-explore-time"><i class="fa fa-check"></i><b>2.5.1</b> Time of day</a></li>
<li class="chapter" data-level="2.5.2" data-path="ebird.html"><a href="ebird.html#ebird-explore-duration"><i class="fa fa-check"></i><b>2.5.2</b> Checklist duration</a></li>
<li class="chapter" data-level="2.5.3" data-path="ebird.html"><a href="ebird.html#ebird-explore-distance"><i class="fa fa-check"></i><b>2.5.3</b> Distance traveled</a></li>
<li class="chapter" data-level="2.5.4" data-path="ebird.html"><a href="ebird.html#ebird-explore-observers"><i class="fa fa-check"></i><b>2.5.4</b> Number of observers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="habitat.html"><a href="habitat.html"><i class="fa fa-check"></i><b>3</b> Habitat Covariates</a><ul>
<li class="chapter" data-level="3.1" data-path="habitat.html"><a href="habitat.html#habitat-intro"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="habitat.html"><a href="habitat.html#habitat-dl"><i class="fa fa-check"></i><b>3.2</b> Downloading MODIS data</a><ul>
<li class="chapter" data-level="3.2.1" data-path="habitat.html"><a href="habitat.html#habitat-dl-r"><i class="fa fa-check"></i><b>3.2.1</b> Download using R</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="habitat.html"><a href="habitat.html#habitat-lsm"><i class="fa fa-check"></i><b>3.3</b> Landscape metrics</a></li>
<li class="chapter" data-level="3.4" data-path="habitat.html"><a href="habitat.html#habitat-prediction"><i class="fa fa-check"></i><b>3.4</b> Prediction surface</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="encounter.html"><a href="encounter.html"><i class="fa fa-check"></i><b>4</b> Modeling Encounter Rate</a><ul>
<li class="chapter" data-level="4.1" data-path="encounter.html"><a href="encounter.html#encouter-intro"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="encounter.html"><a href="encounter.html#encounter-data"><i class="fa fa-check"></i><b>4.2</b> Data preparation</a></li>
<li class="chapter" data-level="4.3" data-path="encounter.html"><a href="encounter.html#encounter-sss"><i class="fa fa-check"></i><b>4.3</b> Spatiotemporal subsampling</a></li>
<li class="chapter" data-level="4.4" data-path="encounter.html"><a href="encounter.html#encounter-rf"><i class="fa fa-check"></i><b>4.4</b> Random forests</a><ul>
<li class="chapter" data-level="4.4.1" data-path="encounter.html"><a href="encounter.html#encounter-rf-cal"><i class="fa fa-check"></i><b>4.4.1</b> Calibration</a></li>
<li class="chapter" data-level="4.4.2" data-path="encounter.html"><a href="encounter.html#encounter-rf-assess"><i class="fa fa-check"></i><b>4.4.2</b> Assessment</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="encounter.html"><a href="encounter.html#encounter-habitat"><i class="fa fa-check"></i><b>4.5</b> Environmental associations</a><ul>
<li class="chapter" data-level="4.5.1" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pi"><i class="fa fa-check"></i><b>4.5.1</b> Predictor importance</a></li>
<li class="chapter" data-level="4.5.2" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pd"><i class="fa fa-check"></i><b>4.5.2</b> Partial dependence</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="encounter.html"><a href="encounter.html#encounter-predict"><i class="fa fa-check"></i><b>4.6</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="occupancy.html"><a href="occupancy.html"><i class="fa fa-check"></i><b>5</b> Modeling Occupancy</a><ul>
<li class="chapter" data-level="5.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-intro"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="occupancy.html"><a href="occupancy.html#occupancy-data"><i class="fa fa-check"></i><b>5.2</b> Data preparation</a><ul>
<li class="chapter" data-level="5.2.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-data-sites"><i class="fa fa-check"></i><b>5.2.1</b> Data formatting</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="occupancy.html"><a href="occupancy.html#encounter-data-sss"><i class="fa fa-check"></i><b>5.3</b> Spatial subsampling</a><ul>
<li class="chapter" data-level="5.3.1" data-path="occupancy.html"><a href="occupancy.html#encounter-data-unmarked"><i class="fa fa-check"></i><b>5.3.1</b> <code>unmarked</code> object</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="occupancy.html"><a href="occupancy.html#occupancy-model"><i class="fa fa-check"></i><b>5.4</b> Occupancy modeling</a><ul>
<li class="chapter" data-level="5.4.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-assess"><i class="fa fa-check"></i><b>5.4.1</b> Assessment</a></li>
<li class="chapter" data-level="5.4.2" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-select"><i class="fa fa-check"></i><b>5.4.2</b> Model selection</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="occupancy.html"><a href="occupancy.html#occupancy-predict"><i class="fa fa-check"></i><b>5.5</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="abundance.html"><a href="abundance.html"><i class="fa fa-check"></i><b>6</b> Modeling Relative Abundance</a><ul>
<li class="chapter" data-level="6.1" data-path="abundance.html"><a href="abundance.html#abundance-intro"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="abundance.html"><a href="abundance.html#abundance-data"><i class="fa fa-check"></i><b>6.2</b> Data preparation</a><ul>
<li class="chapter" data-level="6.2.1" data-path="abundance.html"><a href="abundance.html#abundance-data-sss"><i class="fa fa-check"></i><b>6.2.1</b> Spatiotemporal subsampling</a></li>
<li class="chapter" data-level="6.2.2" data-path="abundance.html"><a href="abundance.html#abundance-data-tt"><i class="fa fa-check"></i><b>6.2.2</b> Test-train split</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="abundance.html"><a href="abundance.html#abundance-model"><i class="fa fa-check"></i><b>6.3</b> Abundance models</a><ul>
<li class="chapter" data-level="6.3.1" data-path="abundance.html"><a href="abundance.html#abundance-model-assess"><i class="fa fa-check"></i><b>6.3.1</b> Assessment</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="abundance.html"><a href="abundance.html#abundance-predict"><i class="fa fa-check"></i><b>6.4</b> Prediction</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Best Practices for Using eBird Data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="encounter" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Modeling Encounter Rate</h1>
<div id="encouter-intro" class="section level2">
<h2><span class="header-section-number">4.1</span> Introduction</h2>
<p>In this chapter we’ll estimate the <strong>encounter rate</strong> of Wood Thrush on eBird checklists in June in BCR 27. We define encounter rate as measuring the probability of an expert eBirder encountering a species on a standard eBird checklist, so that the calculated encounter rates approximate the actual occurrence rates of Wood Thrush. The ecological metric we’re ultimately interested in is the probability that a species occurs at a site (i.e. the occupancy probability). This is usually not possible with semi-structured citizen science data like those from eBird because we typically can’t estimate <em>absolute</em> detectability. However, by accounting for much of the variation in detectability by including effort covariaters in our model, the remaining unaccounted detectability will be more consistent across sites <span class="citation">(Guillera-Arroita et al. <a href="#ref-guillera-arroitaMySpeciesDistribution2015">2015</a>)</span>. Therefore, the encounter rate metric will be relative to occupancy up to a constant of detectability, allowing us to compare species distributions across space and time.</p>
<p><a href="https://en.wikipedia.org/wiki/Random_forest"><strong>Random forests</strong></a> are a general purpose machine learning method applicable to a wide range of <a href="https://en.wikipedia.org/wiki/Statistical_classification">classification</a> and <a href="https://en.wikipedia.org/wiki/Regression_analysis">regression</a> problems, including the task at hand: identifying predictors that classify reporting and non-reporting of a species on eBird checklists. In addition to good predictive performance, random forests are reasonably easy to use and have several efficient implementations in R. Prior to fitting a random forest model, we’ll demonstrate how to address issues of <a href="intro.html#intro-intro">class imbalance and spatial bias</a> using spatial subsampling on a regular grid. After fitting the model, we’ll assess its performance using a subset of data put aside for testing, and calibrate the model to ensure predictions are accurate. Finally, we’ll predict encounter rates throughout the study area and produce maps of these predictions.</p>
</div>
<div id="encounter-data" class="section level2">
<h2><span class="header-section-number">4.2</span> Data preparation</h2>
<p>Let’s get started by loading the necessary packages and data. If you worked through the previous chapters, you should have all the data necessary for this chapter. However, you may want to <a href="https://raw.githubusercontent.com/mstrimas/ebird-best-practices/master/data.zip">download the data package</a>, and unzip it to your working directory, to ensure you’re working with exactly the same data as was used in the creation of this book. Note that the Checklist Calibration Index (CCI), which calibrates observers and checklists against others from similar times and places, is an optional covariate in these models. Including CCI typical leads to marked improvement in model performance; however, due to the sensitive nature of these data you will need to <a href="https://ebird.org/data/download">download them separately</a> after agreeing to the terms and conditions. If you’ve downloaded these data, put the CCI text file in the <code>data/</code> subdirectory of your project.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf)
<span class="kw">library</span>(raster)
<span class="kw">library</span>(dggridR)
<span class="kw">library</span>(lubridate)
<span class="kw">library</span>(ranger)
<span class="kw">library</span>(scam)
<span class="kw">library</span>(PresenceAbsence)
<span class="kw">library</span>(verification)
<span class="kw">library</span>(edarf)
<span class="kw">library</span>(viridis)
<span class="kw">library</span>(fields)
<span class="kw">library</span>(gridExtra)
<span class="kw">library</span>(tidyverse)
<span class="co"># resolve namespace conflicts</span>
select &lt;-<span class="st"> </span>dplyr<span class="op">::</span>select
projection &lt;-<span class="st"> </span>raster<span class="op">::</span>projection

<span class="kw">set.seed</span>(<span class="dv">1</span>)

<span class="co"># ebird data</span>
ebird &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/ebd_woothr_june_bcr27_zf.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># year required to join to habitat data</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">year</span>(observation_date))

<span class="co"># modis habitat covariates</span>
habitat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/modis_pland_location-year.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.integer</span>(year))

<span class="co"># combine ebird and habitat data</span>
ebird_habitat &lt;-<span class="st"> </span><span class="kw">inner_join</span>(ebird, habitat, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;locality_id&quot;</span>, <span class="st">&quot;year&quot;</span>))

<span class="co"># optional checklist calibration index</span>
cci_file &lt;-<span class="st"> &quot;data/cci_june_bcr27.csv&quot;</span>
<span class="cf">if</span> (<span class="kw">file.exists</span>(cci_file)) {
  cci &lt;-<span class="st"> </span><span class="kw">read_csv</span>(cci_file)
  ebird_habitat &lt;-<span class="st"> </span><span class="kw">inner_join</span>(ebird_habitat, cci, <span class="dt">by =</span> <span class="st">&quot;checklist_id&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(checklist_calibration_index))
}

<span class="co"># prediction surface</span>
pred_surface &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/modis_pland_prediction-surface.csv&quot;</span>)
r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;data/prediction-surface.tif&quot;</span>)

<span class="co"># load gis data for making maps</span>
map_proj &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">102003</span>)
ne_land &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_land&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()
bcr &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;bcr&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()
ne_country_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_country_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()
ne_state_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_state_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_geometry</span>()</code></pre>
</div>
<div id="encounter-sss" class="section level2">
<h2><span class="header-section-number">4.3</span> Spatiotemporal subsampling</h2>
<p>As <a href="intro.html#intro-intro">discussed in the introduction</a>, three of the challenges when using citizen science data, such as those from eBird, are <strong>spatial bias</strong>, <strong>temporal bias</strong>, and <strong>class imbalance</strong>. Spatial and temporal bias refers to the tendency of eBird checklists to be distributed non-randomly in space and time, while class imbalance refers to fact that there will be many more non-detections than detections for most species. All three can impact our ability to make reliable inferences from these data. Fortunately, all three can largely be addressed through subsampling the eBird data prior to modeling. In particular, we define an equal area hexagonal grid across the study region, then randomly sample one checklist from each grid cell for each week. To deal with class imbalance, we subsample detections and non-detections separately to ensure we don’t lose too many detections.</p>
<p>Hexagonal grids seem exotic relative to square grids, which may be more familiar, however, they have a variety of benefits <span class="citation">(Sahr <a href="#ref-sahrHexagonalDiscreteGlobal2011">2011</a>)</span> including significantly less spatial distortion. With hexagonal grids we can be sure all the cells are of equal area, which is particularly important if we have a large region for modeling. The R package <a href="https://github.com/r-barnes/dggridR"><code>dggridR</code></a> makes working with hexagonal grids simple and efficient. We’ll construct a grid with 5 km spacing between the centres of adjacent hexagons, then sample randomly from these hexagonal cells.</p>
<p>Before working with the real data, it’s instructive to look at a small toy example, to see how this subsampling process works. We’ll generate a few hundred random points, overlay a hexagonal grid, then sample one point from each cell.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># bounding box to generate points from</span>
bb &lt;-<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">c</span>(<span class="dt">xmin =</span> <span class="fl">-0.1</span>, <span class="dt">xmax =</span> <span class="fl">0.1</span>, <span class="dt">ymin =</span> <span class="fl">-0.1</span>, <span class="dt">ymax =</span> <span class="fl">0.1</span>), 
              <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_sf</span>()
<span class="co"># random points, 10% detections</span>
pts &lt;-<span class="st"> </span><span class="kw">st_sample</span>(bb, <span class="dv">500</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_sf</span>(<span class="kw">as.data.frame</span>(<span class="kw">st_coordinates</span>(.)), <span class="dt">geometry =</span> .) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">lat =</span> Y, <span class="dt">lon =</span> X)

<span class="co"># contruct a hexagonal grid with ~ 5 km between cells</span>
dggs &lt;-<span class="st"> </span><span class="kw">dgconstruct</span>(<span class="dt">spacing =</span> <span class="dv">5</span>)
<span class="co"># for each point, get the grid cell</span>
pts<span class="op">$</span>cell &lt;-<span class="st"> </span><span class="kw">dgGEO_to_SEQNUM</span>(dggs, pts<span class="op">$</span>lon, pts<span class="op">$</span>lat)<span class="op">$</span>seqnum

<span class="co"># sample one checklist per grid cell per week</span>
pts_ss &lt;-<span class="st"> </span>pts <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(cell) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()

<span class="co"># generate polygons for the grid cells</span>
hexagons &lt;-<span class="st"> </span><span class="kw">dgcellstogrid</span>(dggs, <span class="kw">unique</span>(pts<span class="op">$</span>cell), <span class="dt">frame =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_as_sf</span>()
<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> hexagons) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> pts, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> pts_ss, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre>
<p><img src="ebird-best-practices_files/figure-html/encounter-sss-toy-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>Now let’s apply exactly the same approach to subsampling the real eBird checklists.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># generate hexagonal grid with ~ 5 km betweeen cells</span>
dggs &lt;-<span class="st"> </span><span class="kw">dgconstruct</span>(<span class="dt">spacing =</span> <span class="dv">5</span>)
<span class="co"># get hexagonal cell id and week number for each checklist</span>
checklist_cell &lt;-<span class="st"> </span>ebird_habitat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cell =</span> <span class="kw">dgGEO_to_SEQNUM</span>(dggs, longitude, latitude)<span class="op">$</span>seqnum,
         <span class="dt">week =</span> <span class="kw">week</span>(observation_date))
<span class="co"># sample one checklist per grid cell per week</span>
<span class="co"># sample detection/non-detection independently </span>
ebird_ss &lt;-<span class="st"> </span>checklist_cell <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(species_observed, week, cell) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>()</code></pre>
<p>How did this impact the prevalence of detections compared to non-detections?</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># original data</span>
<span class="kw">nrow</span>(ebird_habitat)
<span class="co">#&gt; [1] 40477</span>
<span class="kw">count</span>(ebird_habitat, species_observed) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">percent =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;   species_observed     n percent</span>
<span class="co">#&gt;   &lt;lgl&gt;            &lt;int&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 FALSE            38539  0.952 </span>
<span class="co">#&gt; 2 TRUE              1938  0.0479</span>
<span class="co"># after sampling</span>
<span class="kw">nrow</span>(ebird_ss)
<span class="co">#&gt; [1] 10391</span>
<span class="kw">count</span>(ebird_ss, species_observed) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">percent =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n))
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;   species_observed     n percent</span>
<span class="co">#&gt;   &lt;lgl&gt;            &lt;int&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 FALSE             9201   0.885</span>
<span class="co">#&gt; 2 TRUE              1190   0.115</span></code></pre>
<p>So, the subsampling <em>decreased</em> the overall number of checklists by a factor of about four, but <em>increased</em> the prevalance of detections from 4.80% to 11.5%. This increase in detections will help the random forest model distinguish where birds are being observed; however, we will need to account for this change in prevalence by calibrating our model, which will be covered in Section <a href="encounter.html#encounter-rf-cal">4.4.1</a>. Let’s look at how the subsampling affects the spatial distribution of the observations.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># convert checklists to spatial features</span>
all_pts &lt;-<span class="st"> </span>ebird_habitat <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>,<span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(species_observed)
ss_pts &lt;-<span class="st"> </span>ebird_ss <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>,<span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(species_observed)
both_pts &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">before_ss =</span> all_pts, <span class="dt">after_ss =</span> ss_pts)

<span class="co"># map</span>
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))
<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(both_pts)) {
  <span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>))
  <span class="co"># set up plot area</span>
  <span class="kw">plot</span>(<span class="kw">st_geometry</span>(both_pts[[i]]), <span class="dt">col =</span> <span class="ot">NA</span>)
  <span class="co"># contextual gis data</span>
  <span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">border =</span> <span class="st">&quot;#888888&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">plot</span>(bcr, <span class="dt">col =</span> <span class="st">&quot;#cccccc&quot;</span>, <span class="dt">border =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="co"># ebird observations</span>
  <span class="co"># not observed</span>
  <span class="kw">plot</span>(<span class="kw">st_geometry</span>(both_pts[[i]]),
       <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">cex =</span> <span class="fl">0.1</span>, <span class="dt">col =</span> <span class="kw">alpha</span>(<span class="st">&quot;#555555&quot;</span>, <span class="fl">0.25</span>),
       <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="co"># observed</span>
  <span class="kw">plot</span>(<span class="kw">filter</span>(both_pts[[i]], species_observed) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(),
       <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>, <span class="dt">col =</span> <span class="kw">alpha</span>(<span class="st">&quot;#4daf4a&quot;</span>, <span class="fl">0.5</span>),
       <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="co"># legend</span>
  <span class="kw">legend</span>(<span class="st">&quot;bottomright&quot;</span>, <span class="dt">bty =</span> <span class="st">&quot;n&quot;</span>,
         <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;#555555&quot;</span>, <span class="st">&quot;#4daf4a&quot;</span>),
         <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;Non-detection&quot;</span>, <span class="st">&quot;Detection&quot;</span>),
         <span class="dt">pch =</span> <span class="dv">19</span>)
  <span class="kw">box</span>()
  <span class="kw">par</span>(<span class="dt">new =</span> <span class="ot">TRUE</span>, <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">0</span>))
  <span class="cf">if</span> (<span class="kw">names</span>(both_pts)[i] <span class="op">==</span><span class="st"> &quot;before_ss&quot;</span>) {
    <span class="kw">title</span>(<span class="st">&quot;Wood Thrush eBird Observations</span><span class="ch">\n</span><span class="st">Before subsampling&quot;</span>)
  } <span class="cf">else</span> {
    <span class="kw">title</span>(<span class="st">&quot;After subsampling&quot;</span>)
  }
}</code></pre>
<p><img src="ebird-best-practices_files/figure-html/encounter-sss-map-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>For Wood Thrush, subsampling the detections and non-detections independently is sufficient for dealing with class imbalance; however, for species that are extremely rare, it may be worthwhile retaining all detections or even oversampling detections.</p>
</div>
<div id="encounter-rf" class="section level2">
<h2><span class="header-section-number">4.4</span> Random forests</h2>
<p>Now we’ll use a random forest model to relate detection/non-detection of Wood Thrush to the MODIS habitat covariates, while also accounting for variation in detectability by including a suite of effort covariates. Before we fit the random forest model, we randomly split the data into 80% of checklists for training and 20% for testing. We’ll hold this 20% aside when we fit the model, then use it as an independent data set to test the predictive performance of the model.</p>
<pre class="sourceCode r"><code class="sourceCode r">ebird_split &lt;-<span class="st"> </span>ebird_ss <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># random forests requires an integer repsonse</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">species_observed =</span> <span class="kw">as.integer</span>(species_observed)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># select only the columns to be used in the model</span>
<span class="st">  </span><span class="kw">select</span>(species_observed,
         observation_date,
         time_observations_started, duration_minutes,
         effort_distance_km, number_observers, 
         <span class="kw">contains</span>(<span class="st">&quot;checklist_calibration_index&quot;</span>),
         <span class="kw">starts_with</span>(<span class="st">&quot;pland_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">drop_na</span>()
<span class="co"># split 80/20</span>
ebird_split &lt;-<span class="st"> </span>ebird_split <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">split</span>(<span class="kw">if_else</span>(<span class="kw">runif</span>(<span class="kw">nrow</span>(.)) <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.8</span>, <span class="st">&quot;train&quot;</span>, <span class="st">&quot;test&quot;</span>))
<span class="kw">map_int</span>(ebird_split, nrow)
<span class="co">#&gt;  test train </span>
<span class="co">#&gt;  2075  8316</span></code></pre>
<p>There are several packages for fitting random forests in R; however, we’ll use <a href="https://github.com/imbs-hl/ranger"><code>ranger</code></a>, which is a blazingly fast implementation with all the features we need. We fit a model with 1,000 classification trees (<code>num.trees</code>). For the number of variables randomly sampled at each split (<code>mtry</code>), we used the square root of the number of covariates (21). This choice of parameters will be suitable for a broad range of species distribution modeling tasks.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grow random forest</span>
rf &lt;-<span class="st"> </span><span class="kw">ranger</span>(<span class="dt">formula =</span>  species_observed <span class="op">~</span><span class="st"> </span>., 
             <span class="dt">num.trees =</span> <span class="dv">1000</span>, 
             <span class="dt">mtry =</span> <span class="kw">sqrt</span>(<span class="kw">ncol</span>(ebird_split<span class="op">$</span>train) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>),
             <span class="dt">importance =</span> <span class="st">&quot;impurity&quot;</span>,
             <span class="dt">data =</span> ebird_split<span class="op">$</span>train)</code></pre>
<p>We’ve found that predictions from <code>ranger</code> can be sensitive to the particular checklists that are selection in the spatial subsampling and test/train split steps. To ensure this is not an issue, we suggest running several iterations of this code, using different sets of samples. The random sampling can be controlled by trying different values for the <a href="https://en.wikipedia.org/wiki/Random_seed">ranomd seed</a> set at the <a href="encounter.html#encounter-data">start of the chapter</a> with <code>set.seed(1)</code>.</p>
<div id="encounter-rf-cal" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Calibration</h3>
<p>For various reasons, the predicted probabilities from models do not always align with the observed frequencies of detections. For example, examining all sites with an estimated 0.2 probability of encounter, may in reality have an average encounter rate of 0.35 (35% of sites record the species). Where there is a mismatch between estimated and observed encounter rates, <strong>model calibration</strong> aligns the estimated probabilities to the observed frequencies. For further details on model calibration consult Phillips and Elith <span class="citation">(<a href="#ref-phillipsPOCPlotsCalibrating2010">2010</a>)</span>.</p>
<p>To calibrate our model results, we predict encounter rate for each checklist in the training set, then fit a binomial Generalized Additive Model (GAM) with the real observations as the response and the predicted encounter rate as the predictor variable. We’ll fit the predictor variable using a smooth with four degrees of freedom. To fit the GAM, we’ll use the R package <a href="https://CRAN.R-project.org/package=scam"><code>scam</code></a>, so the shape can be constrained to be monotonically increasing.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># predict on test partition</span>
rf_pred_train &lt;-<span class="st"> </span><span class="kw">predict</span>(rf, <span class="dt">data =</span> ebird_split<span class="op">$</span>train, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
rf_pred_train &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">id =</span> <span class="kw">seq_along</span>(rf_pred_train<span class="op">$</span>predictions),
                        <span class="co"># actual detection/non-detection</span>
                        <span class="dt">obs =</span> ebird_split<span class="op">$</span>train<span class="op">$</span>species_observed,
                        <span class="co"># prediction</span>
                        <span class="dt">pred =</span> rf_pred_train<span class="op">$</span>predictions) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">drop_na</span>()

<span class="co"># fit calibration model</span>
calibration_model &lt;-<span class="st"> </span><span class="kw">scam</span>(obs <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(pred, <span class="dt">k =</span> <span class="dv">5</span>, <span class="dt">bs =</span> <span class="st">&quot;mpi&quot;</span>), 
                          <span class="dt">data =</span> rf_pred_train, 
                          <span class="dt">family =</span> binomial)

<span class="co"># plot</span>
cal_pred &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">pred =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">100</span>))
cal_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(calibration_model, cal_pred, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_cols</span>(cal_pred, <span class="dt">calibrated =</span> .)
<span class="kw">ggplot</span>(cal_pred) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> calibrated) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;RF prediction&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Calibrated prediction&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Calibration model&quot;</span>)</code></pre>
<p><img src="ebird-best-practices_files/figure-html/encounter-rf-cal-cal-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>The calibrated random forest model is now the combination of the original random forest model and the calibration model.</p>
</div>
<div id="encounter-rf-assess" class="section level3">
<h3><span class="header-section-number">4.4.2</span> Assessment</h3>
<p>Now we’ll assess the calibrated random forest model with the 20% test dataset. We’ll use a range of performance metrics to compare the predictions to the actual observations: mean squared error (MSE), sensitivity, specificity, AUC, Kappa, and Brier score. Several of these metrics require the raw predicted probabilities to be classified into detection/non-detection. We’ll do this using a threshold, chosen to maximize the Kappa statistic.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># predict on test data using calibrated model</span>
p_fitted &lt;-<span class="st"> </span><span class="kw">predict</span>(rf, <span class="dt">data =</span> ebird_split<span class="op">$</span>test, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
p_calibrated &lt;-<span class="st"> </span><span class="kw">predict</span>(calibration_model, 
                        <span class="dt">newdata =</span> <span class="kw">tibble</span>(<span class="dt">pred =</span> p_fitted<span class="op">$</span>predictions), 
                        <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
rf_pred_test &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">seq_along</span>(p_calibrated),
                           <span class="co"># actual detection/non-detection</span>
                           <span class="dt">obs =</span> ebird_split<span class="op">$</span>test<span class="op">$</span>species_observed,
                           <span class="co"># calibrated prediction</span>
                           <span class="dt">fit =</span> p_fitted<span class="op">$</span>predictions,
                           <span class="co"># calibrated prediction</span>
                           <span class="dt">cal =</span> p_calibrated) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">drop_na</span>()

<span class="co"># mean squared error (mse)</span>
mse_fit &lt;-<span class="st"> </span><span class="kw">mean</span>((rf_pred_test<span class="op">$</span>obs <span class="op">-</span><span class="st"> </span>rf_pred_test<span class="op">$</span>fit)<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
mse_cal &lt;-<span class="st"> </span><span class="kw">mean</span>((rf_pred_test<span class="op">$</span>obs <span class="op">-</span><span class="st"> </span>rf_pred_test<span class="op">$</span>cal)<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)

<span class="co"># pick threshold to maximize kappa</span>
opt_thresh &lt;-<span class="st"> </span><span class="kw">optimal.thresholds</span>(rf_pred_test, <span class="dt">opt.methods =</span> <span class="st">&quot;MaxKappa&quot;</span>)

<span class="co"># calculate accuracy metrics: auc, kappa, sensitivity, specificity, brier</span>
metrics_fit &lt;-<span class="st"> </span>rf_pred_test <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, obs, fit) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">presence.absence.accuracy</span>(<span class="dt">threshold =</span> opt_thresh<span class="op">$</span>fit, 
                            <span class="dt">na.rm =</span> <span class="ot">TRUE</span>, 
                            <span class="dt">st.dev =</span> <span class="ot">FALSE</span>)
metrics_cal &lt;-<span class="st"> </span>rf_pred_test <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(id, obs, cal) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">presence.absence.accuracy</span>(<span class="dt">threshold =</span> opt_thresh<span class="op">$</span>cal, 
                            <span class="dt">na.rm =</span> <span class="ot">TRUE</span>, 
                            <span class="dt">st.dev =</span> <span class="ot">FALSE</span>)

rf_assessment &lt;-<span class="st"> </span><span class="kw">tibble</span>(
  <span class="dt">model =</span> <span class="kw">c</span>(<span class="st">&quot;RF&quot;</span>, <span class="st">&quot;Calibrated RF&quot;</span>),
  <span class="dt">mse =</span> <span class="kw">c</span>(mse_fit, mse_cal),
  <span class="dt">sensitivity =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>sensitivity, metrics_cal<span class="op">$</span>sensitivity),
  <span class="dt">specificity =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>specificity, metrics_cal<span class="op">$</span>specificity),
  <span class="dt">auc =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>AUC, metrics_cal<span class="op">$</span>AUC),
  <span class="dt">kappa =</span> <span class="kw">c</span>(metrics_fit<span class="op">$</span>Kappa, metrics_cal<span class="op">$</span>Kappa),
  <span class="dt">brier =</span> <span class="kw">c</span>(<span class="kw">brier</span>(rf_pred_test<span class="op">$</span>obs, rf_pred_test<span class="op">$</span>fit)<span class="op">$</span>bs, 
            <span class="kw">brier</span>(rf_pred_test<span class="op">$</span>obs, rf_pred_test<span class="op">$</span>cal)<span class="op">$</span>bs)
)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="right">mse</th>
<th align="right">sensitivity</th>
<th align="right">specificity</th>
<th align="right">auc</th>
<th align="right">kappa</th>
<th align="right">brier</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">RF</td>
<td align="right">0.088</td>
<td align="right">0.552</td>
<td align="right">0.870</td>
<td align="right">0.808</td>
<td align="right">0.342</td>
<td align="right">0.089</td>
</tr>
<tr class="even">
<td align="left">Calibrated RF</td>
<td align="right">0.116</td>
<td align="right">0.295</td>
<td align="right">0.944</td>
<td align="right">0.808</td>
<td align="right">0.271</td>
<td align="right">0.109</td>
</tr>
</tbody>
</table>
<p>** Daniel: can you add something here about the different metrics? **</p>
</div>
</div>
<div id="encounter-habitat" class="section level2">
<h2><span class="header-section-number">4.5</span> Environmental associations</h2>
<p>From the random forest model, we can glean two important sources of information about the association between Wood Thrush detection and features of their local environment. First, <strong>predictor importance</strong> is a measure of the predictive power of each covariate, and is calculated as a byproduct of fitting a random forest model. Second, <strong>partial dependence</strong> plots estimate the marginal effect of one predictor holding all other predictors constant.</p>
<div id="encounter-habitat-pi" class="section level3">
<h3><span class="header-section-number">4.5.1</span> Predictor importance</h3>
<p>During the process of fitting a random forest model, some variables are removed at each node of the trees that make up the random forest. <strong>Predictor importance</strong> is based on the mean decrease in accuracy of the model when a given covariate is not used. It’s technically an average <a href="https://en.wikipedia.org/wiki/Gini_coefficient">Gini index</a>, but essentially larger values indicate that a predictor is more important to the model.</p>
<pre class="sourceCode r"><code class="sourceCode r">pi &lt;-<span class="st"> </span><span class="kw">enframe</span>(rf<span class="op">$</span>variable.importance, <span class="st">&quot;predictor&quot;</span>, <span class="st">&quot;importance&quot;</span>)

<span class="kw">ggplot</span>(pi)<span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">fct_reorder</span>(predictor, importance), <span class="dt">y =</span> importance) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">colour =</span> <span class="st">&quot;#555555&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, 
       <span class="dt">y =</span> <span class="st">&quot;Predictor Importance (Gini Index)&quot;</span>,
       <span class="dt">fill =</span> <span class="st">&quot;Predictor Importance (Gini Index)&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.grid.major.x =</span> <span class="kw">element_line</span>(<span class="dt">colour =</span> <span class="st">&quot;#cccccc&quot;</span>, <span class="dt">size =</span> <span class="fl">0.5</span>))</code></pre>
<p><img src="ebird-best-practices_files/figure-html/encounter-habitat-pi-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>The most important predictors of detection/non-detection are generally effort variables. Indeed, that’s the case here: CCI, start time, date, and checklist duration are all important predictors. The top environmetal predictors are the proportion of woody savanna (<code>pland_08</code>) and deciduous broadleaf forest (<code>pland_04</code>). Note that high importance doesn’t tell us the direction of the relationship with detection, for that we’ll have to look at partial dependence plots.</p>
</div>
<div id="encounter-habitat-pd" class="section level3">
<h3><span class="header-section-number">4.5.2</span> Partial dependence</h3>
<p><strong>Partial dependence</strong> plots show the marginal effect of a given predictor on encounter rate averaged across the other predictors. These plots are generated by predicting encounter rate at a regular sequence of points across the full range of values of a given predictor. At each predictor value, predictions of encounter rate are made for a random subsample of the training dataset with the focal predictor fixed, but all other predictors left as is. The encounter rate predictions are then averaged across all the checklists in the training dataset giving an estimate of the average encounter rate at a specific value of the focal predictor. Fortunately, the R package <code>edarf</code> has a function to calculate partial dependence from random forest models. Let’s look at partial dependence plots for the most important predictors.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># top 9 predictors other than date</span>
top_pred &lt;-<span class="st"> </span>pi <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>predictor <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;observation_date&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">9</span>, <span class="dt">wt =</span> importance)

<span class="co"># calculate partial dependence for each predictor</span>
pd &lt;-<span class="st"> </span>top_pred<span class="op">$</span>predictor <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">map_df</span>(<span class="op">~</span><span class="st"> </span><span class="kw">partial_dependence</span>(rf, .x, <span class="dt">data =</span> ebird_split<span class="op">$</span>train) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">           </span><span class="kw">mutate</span>(<span class="dt">variable =</span> .x) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">           </span><span class="kw">set_names</span>(<span class="kw">c</span>(<span class="st">&quot;value&quot;</span>,  <span class="st">&quot;prob_det&quot;</span>, <span class="st">&quot;variable&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(variable, value, prob_det)

<span class="co"># plot</span>
<span class="kw">ggplot</span>(pd) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> value, <span class="dt">y =</span> prob_det) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span><span class="kw">as_factor</span>(variable), <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="st">&quot;Encounter Rate&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),
        <span class="dt">axis.line =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;grey60&quot;</span>),
        <span class="dt">axis.ticks  =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;grey60&quot;</span>))</code></pre>
<p><img src="ebird-best-practices_files/figure-html/encounter-habitat-pd-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>There are a range of interesting responses here. As seen in Section <a href="ebird.html#ebird-explore">2.5</a>, the encounter rate for Wood Thrush peaks early in the morning when they’re most likely to be singing, then quickly drops off in the middle of the day, before slightly increasing in the evening. The CCI seems to show a threshold effect; there’s a jump from 10% to 30% encounter rate around a CCI of 2. Wood Thrush can be hard to see, but have a <a href="https://macaulaylibrary.org/asset/125223">prominent and distinctive call</a>, emblematic of North America’s eastern hardwood forest, and perhaps less experienced birders aren’t able to recognize this call. Some other predictors show a more smoothly increasing relationship with encounter rate, for example, as the landscape contains more deciduous forest (<code>pland_04</code>), the encounter rate increases.</p>
</div>
</div>
<div id="encounter-predict" class="section level2">
<h2><span class="header-section-number">4.6</span> Prediction</h2>
<p>Now for the fun part: let’s use the calibrated random forest model to make a map of Wood Thrush encounter rate in BCR 27! In Section <a href="habitat.html#habitat-prediction">3.4</a>, we created a prediction surface consisting of the PLAND habitat covariates summarized on a regular grid of points across BCR 27. In this section, we’ll make predictions of encounter rate at these points. However, first we need to bring effort variables into this prediction surface. We’ll make predictions for a <strong>standard eBird checklist</strong>: a 1 km, 1 hour traveling count done by a single expert eBirder (CCI = 2) at the peak time of day for detecting this species. Finally, we’ll make these predictions for June 15, 2017, the middle of our June focal window for the latest year for which MODIS landcover data exist.</p>
<p>To find the time of day with the highest detection probability, we can look for the peak of the partial dependence plot. The one caveat to this approach is that it’s important we focus on times of day for which there are enough data to make predictions. In particular, when there is an increasing trend in detectability as observations start earlier in the morning and few checklists late at night, the model may incorrectly extrapolate that trend to show highest detectability at night. Let’s start by looking at a plot to see if this is happening here.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># find peak time of day from partial dependence</span>
pd_time &lt;-<span class="st"> </span><span class="kw">partial_dependence</span>(rf, 
                              <span class="dt">vars =</span> <span class="st">&quot;time_observations_started&quot;</span>, 
                              <span class="co"># make estimates at 10 minute intervals</span>
                              <span class="co"># use the entire training dataset for estimation</span>
                              <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">24</span> <span class="op">*</span><span class="st"> </span><span class="dv">6</span>, <span class="kw">nrow</span>(ebird_split<span class="op">$</span>train)), 
                              <span class="dt">data =</span> ebird_split<span class="op">$</span>train)
<span class="co">#&gt; Aggregating predictions.. Progress: 98%. Estimated remaining time: 0 seconds.</span>

<span class="co"># histogram</span>
g_hist &lt;-<span class="st"> </span><span class="kw">ggplot</span>(ebird_split<span class="op">$</span>train) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> time_observations_started) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">center =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="st">&quot;grey30&quot;</span>,
                 <span class="dt">fill =</span> <span class="st">&quot;grey50&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dt">by =</span> <span class="dv">3</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>comma) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Hours since midnight&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;# checklists&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Distribution of observation start times&quot;</span>)

<span class="co"># gam</span>
g_pd &lt;-<span class="st"> </span><span class="kw">ggplot</span>(pd_time) <span class="op">+</span>
<span class="st">  </span><span class="kw">aes</span>(<span class="dt">x =</span> time_observations_started, <span class="dt">y =</span> species_observed) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dt">by =</span> <span class="dv">3</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Hours since midnight&quot;</span>,
       <span class="dt">y =</span> <span class="st">&quot;Probability of reporting&quot;</span>,
       <span class="dt">title =</span> <span class="st">&quot;Observation start time partial dependence&quot;</span>)

<span class="co"># combine</span>
<span class="kw">grid.arrange</span>(g_hist, g_pd)</code></pre>
<p><img src="ebird-best-practices_files/figure-html/encounter-predict-time-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
<p>As expected, the peak of detectibility is occurring at start times near midnight, which is an artifact of the low data density at night. Let’s instead look for the peak time within hours of the day that contain at least 1% of the training data.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># hours with at least 1% of checklists</span>
search_hours &lt;-<span class="st"> </span>ebird_split<span class="op">$</span>train <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">hour =</span> <span class="kw">floor</span>(time_observations_started)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>(hour) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pct =</span> n <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(pct <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.01</span>)

<span class="co"># constrained peak time</span>
t_peak &lt;-<span class="st"> </span>pd_time <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">floor</span>(time_observations_started) <span class="op">%in%</span><span class="st"> </span>search_hours<span class="op">$</span>hour) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">1</span>, <span class="dt">wt =</span> <span class="kw">desc</span>(time_observations_started)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(time_observations_started)</code></pre>
<p>Based on this analysis, the best time for viewing Wood Thrush is at 5:09 AM. Now we can add the effort variables to the prediction surface.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># add effort covariates to prediction </span>
pred_surface_eff &lt;-<span class="st"> </span>pred_surface <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">observation_date =</span> <span class="kw">ymd</span>(<span class="st">&quot;2016-06-15&quot;</span>),
         <span class="dt">time_observations_started =</span> t_peak,
         <span class="dt">duration_minutes =</span> <span class="dv">60</span>,
         <span class="dt">effort_distance_km =</span> <span class="dv">1</span>,
         <span class="dt">number_observers =</span> <span class="dv">1</span>,
         <span class="dt">checklist_calibration_index =</span> <span class="dv">2</span>)

<span class="co"># predict</span>
pred_rf &lt;-<span class="st"> </span><span class="kw">predict</span>(rf, <span class="dt">data =</span> pred_surface_eff, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
<span class="co"># apply calibration models</span>
pred_rf_cal &lt;-<span class="st"> </span><span class="kw">predict</span>(calibration_model, 
                       <span class="kw">data.frame</span>(<span class="dt">pred =</span> pred_rf<span class="op">$</span>predictions), 
                       <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
<span class="co"># add to prediction surface</span>
pred_er &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(pred_surface_eff, <span class="dt">encounter_rate =</span> pred_rf_cal) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(latitude, longitude, encounter_rate)</code></pre>
<p>Next, we’ll convert this data frame to spatial points using <code>sf</code>, then rasterize the points using the prediction surface raster template.</p>
<pre class="sourceCode r"><code class="sourceCode r">r_pred &lt;-<span class="st"> </span>pred_er <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> <span class="kw">projection</span>(r)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rasterize</span>(r)
r_pred &lt;-<span class="st"> </span>r_pred[[<span class="op">-</span><span class="dv">1</span>]]

<span class="co"># save the raster</span>
<span class="kw">writeRaster</span>(r_pred, <span class="st">&quot;output/rf-model_encounter-rate_woothr.tif&quot;</span>, 
            <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</code></pre>
<p>Finally, we can map these predictions!</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># project predictions</span>
r_pred_proj &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(r_pred, <span class="dt">crs =</span> map_proj<span class="op">$</span>proj4string, <span class="dt">method =</span> <span class="st">&quot;ngb&quot;</span>)

<span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">3.5</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>))
<span class="co"># set up plot area</span>
<span class="kw">plot</span>(bcr, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="ot">NA</span>)
<span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">border =</span> <span class="st">&quot;#888888&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)

<span class="co"># modified plasma palette</span>
plasma_rev &lt;-<span class="st"> </span><span class="kw">rev</span>(<span class="kw">plasma</span>(<span class="dv">25</span>, <span class="dt">end =</span> <span class="fl">0.9</span>))
gray_int &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(<span class="kw">c</span>(<span class="st">&quot;#dddddd&quot;</span>, plasma_rev[<span class="dv">1</span>]))
pal &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">gray_int</span>(<span class="dv">4</span>)[<span class="dv">2</span>], plasma_rev)

<span class="co"># encounter rate</span>
mx &lt;-<span class="st"> </span><span class="kw">ceiling</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span><span class="kw">cellStats</span>(r_pred_proj, max)) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>
brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, mx, <span class="dt">length.out =</span> <span class="kw">length</span>(pal) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)
<span class="kw">plot</span>(r_pred_proj, 
     <span class="dt">col =</span> pal, <span class="dt">breaks =</span> brks, 
     <span class="dt">maxpixels =</span> <span class="kw">ncell</span>(r_pred_proj),
     <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)

<span class="co"># borders</span>
<span class="kw">plot</span>(bcr, <span class="dt">border =</span> <span class="st">&quot;#000000&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">box</span>()

<span class="co"># legend</span>
<span class="kw">par</span>(<span class="dt">new =</span> <span class="ot">TRUE</span>, <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))
title &lt;-<span class="st"> &quot;Wood Thrush Encounter Rate&quot;</span>
lbl_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, mx, <span class="dt">by =</span> <span class="fl">0.1</span>)
<span class="kw">image.plot</span>(<span class="dt">zlim =</span> <span class="kw">range</span>(brks), <span class="dt">legend.only =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> pal,
           <span class="dt">smallplot =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.06</span>, <span class="fl">0.09</span>),
           <span class="dt">horizontal =</span> <span class="ot">TRUE</span>,
           <span class="dt">axis.args =</span> <span class="kw">list</span>(<span class="dt">at =</span> lbl_brks, <span class="dt">labels =</span> lbl_brks,
                            <span class="dt">fg =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">col.axis =</span> <span class="st">&quot;black&quot;</span>,
                            <span class="dt">cex.axis =</span> <span class="fl">0.75</span>, <span class="dt">lwd.ticks =</span> <span class="fl">0.5</span>,
                            <span class="dt">padj =</span> <span class="fl">-1.5</span>),
           <span class="dt">legend.args =</span> <span class="kw">list</span>(<span class="dt">text =</span> title,
                              <span class="dt">side =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>,
                              <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">line =</span> <span class="dv">0</span>))</code></pre>
<p><img src="ebird-best-practices_files/figure-html/encounter-predict-map-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-guillera-arroitaMySpeciesDistribution2015">
<p>Guillera-Arroita, Gurutzeta, José J. Lahoz-Monfort, Jane Elith, Ascelin Gordon, Heini Kujala, Pia E. Lentini, Michael A. McCarthy, Reid Tingley, and Brendan A. Wintle. 2015. “Is My Species Distribution Model Fit for Purpose? Matching Data and Models to Applications.” <em>Global Ecology and Biogeography</em> 24 (3): 276–92.</p>
</div>
<div id="ref-phillipsPOCPlotsCalibrating2010">
<p>Phillips, Steven J., and Jane Elith. 2010. “POC Plots: Calibrating Species Distribution Models with Presence-Only Data.” <em>Ecology</em> 91 (8): 2476–84.</p>
</div>
<div id="ref-sahrHexagonalDiscreteGlobal2011">
<p>Sahr, Kevin. 2011. “Hexagonal Discrete Global Grid Systems for Geospatial Computing.” <em>Archiwum Fotogrametrii, Kartografii I Teledetekcji</em> 22: 363–76.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="habitat.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="occupancy.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/mstrimas/ebird-best-practices/edit/master/04_encounter-rate.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
